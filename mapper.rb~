module Mapper
    
  # responsible for loading price-lists and comparing them
  class PriceManager
    attr_reader :prices
    def initialize(*filenames)
      @prices = Array.new # <= array of Price objects
      @mutex = Mutex.new # <= for synchronization between threads
      @timeMeasure = Hash.new # <= for measuring block execution
      loadPrices(filenames) unless filenames.empty?
    end
    # приймає масив прайсів
    def loadPrices(filenames)
      #p "is array: #{filenames.kind_of?(Array)}"
      #p "is empty: #{filenames.empty?}"
      #перевіряємо чи це масив
      raise ArgumentError, 'must be array of files #{filenames.kind_of?}' unless filenames.kind_of?(Array) 
      #витягуємо зміст прайс-листа для подальшої обробки
      time_load_prices = Time.now
      @timeMeasure[:loadPrices] = {};
      @timeMeasure[:threads] = []
      threads = filenames.map.with_index do |filename, index| #20
			
        start_thread = Time.now
        t = Thread.new do
          content = File.read filename
          @mutex.synchronize do
				    @prices << Price.new(filename, content)
          end
        end
        t.join
        @timeMeasure[:threads] << {:diff => Time.now - start_thread }
      end
      @timeMeasure[:loadPrices][:duration] = Time.now - time_load_prices
      p @timeMeasure
    end
  end
  class Price
    def initialize(filename, content)
      @title, @content = filename, content
      p "Successfully created Price object!"
    end
  end
end

Mapper::PriceManager.new "ktc-price.xls"
